# Ensure heavy Vagrant operations (box storage and temp extraction)
# use the large, authorized storage at /home/wscherre/sgoinfre to avoid
# running out of space on the local small partition.
SGOINFRE = "/home/wscherre/sgoinfre"
VAGRANT_HOME_DIR = File.join(SGOINFRE, ".vagrant.d")
VAGRANT_TMP_DIR = File.join(SGOINFRE, "vagrant_tmp")

[VAGRANT_HOME_DIR, VAGRANT_TMP_DIR].each do |d|
  begin
    Dir.mkdir(d) unless File.directory?(d)
  rescue SystemCallError
    # ignore; Vagrant will report errors later if not writable
  end
end

# Make Vagrant and temporary extraction use the sgoinfre paths for this
# vagrant run. This sets environment variables for the running Vagrant
# process while it evaluates this Vagrantfile.
ENV['VAGRANT_HOME'] = VAGRANT_HOME_DIR
ENV['TMPDIR'] = VAGRANT_TMP_DIR

Vagrant.configure("2") do |config|
  # --- Base OS ---
  # Use Debian (Bookworm) instead of Ubuntu
  config.vm.box = "debian/bookworm64"

  # --- Utiliser VirtualBox explicitement ---
  config.vm.provider "virtualbox" do |vb|
    vb.name = "incelption"
    vb.memory = 4096
    vb.cpus = 4
    vb.gui = true
    # Use a modern graphics controller for Linux guests
    vb.customize ["modifyvm", :id, "--graphicscontroller", "vmsvga"]
  end

  # --- Dossier partagé (optionnel) ---
  # Change "./" par un dossier spécifique si tu veux
  config.vm.synced_folder "/home/wscherre/sgoinfre", "/home/wscherre/sgoinfre"

  # Forward RDP (guest 3389) to host 33890 for remote GUI access
  config.vm.network "forwarded_port", guest: 3389, host: 33890, auto_correct: true

  # --- Provisioning ---
  config.vm.provision "shell", inline: <<-SHELL
    # STEP 1: Update system and kernel first
    echo ">>> Mise à jour du système (peut prendre quelques minutes)"
    apt-get update -y
    apt-get dist-upgrade -y

    # Create VM user 'wscherre' with home /home/wscherre, set initial password, and add to sudo
    if ! id -u wscherre >/dev/null 2>&1; then
      adduser --disabled-password --gecos "" wscherre
      # set initial password to 'changeme' (user should change it after first login)
      echo "wscherre:changeme" | chpasswd
      usermod -aG sudo wscherre || true
    fi
    # Ensure the synced directory exists and is owned by the vm user
    mkdir -p /home/wscherre/sgoinfre || true
    chown -R wscherre:wscherre /home/wscherre || true

    echo ">>> Installation des dépendances"
    # Install packages needed to build kernel modules for VirtualBox Guest Additions
    # This will install headers for the NEW kernel we just got from dist-upgrade
    apt-get install -y \
      apt-transport-https \
      ca-certificates \
      curl \
      gnupg \
      lsb-release \
      software-properties-common \
      zsh \
      sudo \
      build-essential \
      dkms \
      "linux-headers-$(uname -r)"
  
    echo ">>> Installation d'un bureau léger (Xfce) et LightDM"
    # Install a lightweight desktop, display manager, and the underlying X server
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends xfce4 xfce4-goodies lightdm xserver-xorg

    # Autologin was removed for security. User will need to log in via the console.
    systemctl enable lightdm || true
    systemctl set-default graphical.target || true

    echo ">>> Installation de Docker"
    # Use Docker's Debian repository when provisioning a Debian guest
    curl -fsSL https://download.docker.com/linux/debian/gpg | apt-key add -
    add-apt-repository \
      "deb [arch=amd64] https://download.docker.com/linux/debian \
      $(lsb_release -cs) \
      stable"
    apt-get update -y
    apt-get install -y docker-ce docker-ce-cli containerd.io

    echo ">>> Ajout des utilisateurs au groupe docker"
    usermod -aG docker vagrant || true
    usermod -aG docker wscherre || true

    echo ">>> Installation de Docker Compose"
    DOCKER_COMPOSE_VERSION="2.27.0"
    curl -SL \
      https://github.com/docker/compose/releases/download/v${DOCKER_COMPOSE_VERSION}/docker-compose-Linux-x86_64 \
      -o /home/wscherre/sgoinfre/docker-compose
    chmod +x /home/wscherre/sgoinfre/docker-compose

    echo ">>> Changement du shell par défaut -> zsh"
    chsh -s $(which zsh) vagrant

    echo "Installation terminée ✔"
    echo "NOTE: A reboot is required for all changes to take effect."
    echo "Please run 'vagrant reload' after this provisioner finishes."
  SHELL

  # --- Final Reboot ---
  # This ensures the VM comes up cleanly with all services running after provisioning.
  # config.vm.provision :reload
end
